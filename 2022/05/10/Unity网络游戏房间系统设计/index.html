<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="注册登录与游戏房间大厅系统的设计一些坑注意:(1)避免使用new来直接生成继承MonoBehavior的类的对象,如下: (11条消息) Unity的坑——避免用New来创建继承于MonoBehaviour脚本的对象_弹吉他的小刘鸭的博客-CSDN博客_unity銝要ew (2)设计UI面板类的组件在Set Parent的时候记得把第二个参数设置为false!!   在UI篇当中,我们制作了如下的">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity网络游戏房间系统设计">
<meta property="og:url" content="http://example.com/2022/05/10/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/index.html">
<meta property="og:site_name" content="ChrisZhang">
<meta property="og:description" content="注册登录与游戏房间大厅系统的设计一些坑注意:(1)避免使用new来直接生成继承MonoBehavior的类的对象,如下: (11条消息) Unity的坑——避免用New来创建继承于MonoBehaviour脚本的对象_弹吉他的小刘鸭的博客-CSDN博客_unity銝要ew (2)设计UI面板类的组件在Set Parent的时候记得把第二个参数设置为false!!   在UI篇当中,我们制作了如下的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220504223219111.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220504224435011.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220507221114035.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220507222700797.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220507223237101.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508103921361.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508111050807.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508112947275.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508113049214.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508132903711.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508121230629.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508123043875.png">
<meta property="og:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508132442166.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508134308817.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508134621965.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508135859805.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508175241428.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508181103014.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508195422297.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508205249047.png">
<meta property="article:published_time" content="2022-05-10T07:11:00.000Z">
<meta property="article:modified_time" content="2022-05-10T07:13:55.929Z">
<meta property="article:author" content="ChrisZhang">
<meta property="article:tag" content="网络游戏设计">
<meta property="article:tag" content="Unity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220504223219111.png">

<link rel="canonical" href="http://example.com/2022/05/10/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Unity网络游戏房间系统设计 | ChrisZhang</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ChrisZhang</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/10/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ChrisZhang">
      <meta itemprop="description" content="我的技美学习之路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ChrisZhang">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Unity网络游戏房间系统设计
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-10 15:11:00 / 修改时间：15:13:55" itemprop="dateCreated datePublished" datetime="2022-05-10T15:11:00+08:00">2022-05-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F/" itemprop="url" rel="index"><span itemprop="name">网络游戏</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="注册登录与游戏房间大厅系统的设计"><a href="#注册登录与游戏房间大厅系统的设计" class="headerlink" title="注册登录与游戏房间大厅系统的设计"></a>注册登录与游戏房间大厅系统的设计</h1><h2 id="一些坑注意"><a href="#一些坑注意" class="headerlink" title="一些坑注意:"></a>一些坑注意:</h2><p>(1)避免使用new来直接生成继承MonoBehavior的类的对象,如下:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/alexhu2010q/article/details/106695166">(11条消息) Unity的坑——避免用New来创建继承于MonoBehaviour脚本的对象_弹吉他的小刘鸭的博客-CSDN博客_unity銝要ew</a></p>
<p>(2)设计UI面板类的组件在Set Parent的时候记得把第二个参数设置为false!!</p>
<br/>

<p>在UI篇当中,我们制作了如下的房间系统界面:</p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220504223219111.png" alt="image-20220504223219111"></p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220504224435011.png" alt="image-20220504224435011"></p>
<p>现在我们需要为设计的界面编写相应的服务端逻辑,来解决房间的问题.不过在这之前,我们希望玩家可以有注册和登录功能,这样在联机的时候才能很好地看到其他玩家的信息.</p>
<h1 id="一-强大的通用界面模块"><a href="#一-强大的通用界面模块" class="headerlink" title="一.强大的通用界面模块"></a>一.强大的通用界面模块</h1><p>如果我们每一个界面的生成和点击事件都需要单独一个函数来处理,那么就会很繁琐,因此这里我们采用页面管理器的方法来辅助程序设计.</p>
<p>首先， 每一个面板对应一个类，在这个类里面编写面板的功能。 再定义一个界面管理器， 通过它来控制界面的显示和关闭。界面管理器有两个基本方法， 分别是Open和Close。</p>
<p>形如:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PanelManager.Open&lt;XXXPanel&gt;(); </span><br><span class="line">PanelManager.Close&lt;XXXPanel&gt;();</span><br></pre></td></tr></table></figure>

<p>此时比如想要调出登录界面,只需要用<code>PanelManager.Open&lt;LoginPanel&gt;()</code>即可.(注:LoginPanel也是客户端Socket绑定服务端并进行连接的类)</p>
<br/>

<h2 id="1-通用界面模块"><a href="#1-通用界面模块" class="headerlink" title="1.通用界面模块"></a>1.通用界面模块</h2><p>除了基本的Open和Close方法,PanelManager一般还会包括一个列表(这里叫panels),用来索引已经打开的界面,避免重复打开.</p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220507221114035.png" alt="image-20220507221114035"></p>
<p>xxxPanel继承于面板基类(这里命名为BasePanel),表示具体的面板以及该面板的功能逻辑,每个面板形如下面的结构:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoginPanel</span> : <span class="title">BasePanel</span> &#123;</span><br><span class="line">	<span class="comment">//账号输入框</span></span><br><span class="line">	<span class="keyword">private</span> InputField idInput;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span> &#123;</span><br><span class="line">		skinPath = <span class="string">&quot;LoginPanel&quot;</span>;</span><br><span class="line">		layer = PanelManager.Layer.Panel;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//显示</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span> &#123;</span><br><span class="line">		<span class="comment">//寻找组件</span></span><br><span class="line">		idInput = skin.transform.Find(<span class="string">&quot;IdInput&quot;</span>).GetComponent&lt;InputField&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span> &#123;</span><br><span class="line">        </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中OnInit,OnShow,OnClose为三个固定的方法,当调用PanelManager的Open方法时,界面管理器会依次调用OnInit,OnShow,开发者可以在里面写一些初始方法,比如添加按钮,网络信息监听等.</p>
<p>OnClose方法中,可以写一些释放资源的功能(比如取消网络监听)</p>
<br/>

<h3 id="其他说明"><a href="#其他说明" class="headerlink" title="其他说明"></a>其他说明</h3><p>OnInit方法当中设置了skinPath和layer,这两个属性都在BasePanel当中定义:</p>
<ul>
<li>skinPath会使得程序动态地加载界面资源;</li>
<li>layer表示层级,比如有些面板总是会显示在最上层(比如提示面板),就可以通过layer来设置面板的渲染顺序.</li>
</ul>
<br/>

<h2 id="2-场景结构"><a href="#2-场景结构" class="headerlink" title="2.场景结构"></a>2.场景结构</h2><p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220507222700797.png" alt="image-20220507222700797"></p>
<p>其中:</p>
<ul>
<li>Root为空节点,一直存在</li>
<li>Canvas为画布,所有的UI都要绘制在这上面</li>
<li>接下来的Panel和Tip决定了两个层级,比如提示类的放置在Tip层级上.层级将会决定渲染顺序.</li>
</ul>
<br/>



<h2 id="3-面板基类BasePanel"><a href="#3-面板基类BasePanel" class="headerlink" title="3.面板基类BasePanel"></a>3.面板基类BasePanel</h2><h3 id="1-设计要点"><a href="#1-设计要点" class="headerlink" title="(1)设计要点"></a>(1)设计要点</h3><p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220507223237101.png" alt="image-20220507223237101"></p>
<h3 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="(2) 代码实现"></a>(2) 代码实现</h3><p>有两个文件需要写,分别是BasePanel和PanelManager两个文件.</p>
<p>接下来是BasePanel类:</p>
<p>程序会通过ResManager加载skinPath设定的资源,然后加载和实例化,并通过skin成员引用实例化的对象.Close方法是对PanelManager.Close的简单封装,方便写程序.其中name表示类名,OnInit,OnShow,OnClose为三个虚方法,由具体的面板类去实现,OnShow方法的参数是<code>params objects[] para </code>,表示可变参数.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BasePanel</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="comment">//皮肤路径</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> skinPath;</span><br><span class="line">	<span class="comment">//皮肤</span></span><br><span class="line">	<span class="keyword">public</span> GameObject skin;</span><br><span class="line">	<span class="comment">//层级</span></span><br><span class="line">	<span class="keyword">public</span> PanelManager.Layer layer = PanelManager.Layer.Panel; <span class="comment">//这个后续会实现</span></span><br><span class="line">	<span class="comment">//初始化</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>()</span>&#123;</span><br><span class="line">		<span class="comment">//皮肤</span></span><br><span class="line">		GameObject skinPrefab = ResManager.LoadPrefab(skinPath);</span><br><span class="line">		skin = (GameObject)Instantiate(skinPrefab);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span>&#123;</span><br><span class="line">		<span class="built_in">string</span> name = <span class="keyword">this</span>.GetType().ToString();</span><br><span class="line">		PanelManager.Close(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化时</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//显示时</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] para</span>)</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭时</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span>&#123;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>补充:ResManager的代码如下(<strong>这就意味着:这些要加载的面板要做成预制体放置在Resources文件夹下,以便让PanelManager来加载他们</strong>):</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ResManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//加载预设</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameObject <span class="title">LoadPrefab</span>(<span class="params"><span class="built_in">string</span> path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Resources.Load&lt;GameObject&gt;(path);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="4-界面管理器PanelManager"><a href="#4-界面管理器PanelManager" class="headerlink" title="4.界面管理器PanelManager"></a>4.界面管理器PanelManager</h2><p>有三项功能:</p>
<ul>
<li>层级管理</li>
<li>打开面板</li>
<li>关闭面板</li>
</ul>
<p>对于层级管理,这里使用Dictionary来让layers和场景物体相对应,比如后续让layers[Layer.Panel]指向”Root&#x2F;Canvas&#x2F;Panel”(场景中的结点).实现效果如下:</p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508103921361.png" alt="image-20220508103921361"></p>
<p>而panels列表则会保存所有已经打开的面板,从而阻止重复打开,方便实现关闭功能.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PanelManager</span>&#123;  </span><br><span class="line">	<span class="comment">//Layer</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">enum</span> Layer&#123;</span><br><span class="line">		Panel,</span><br><span class="line">		Tip,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//层级列表</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;Layer, Transform&gt; layers = <span class="keyword">new</span> Dictionary&lt;Layer, Transform&gt;();</span><br><span class="line">	<span class="comment">//面板列表</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, BasePanel&gt; panels = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, BasePanel&gt;();</span><br><span class="line">	<span class="comment">//结构</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Transform root;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Transform canvas;</span><br><span class="line">	<span class="comment">//初始化</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>()</span>&#123;</span><br><span class="line">		root = GameObject.Find(<span class="string">&quot;Root&quot;</span>).transform;  <span class="comment">//找到场景当中的对应物体</span></span><br><span class="line">		canvas = root.Find(<span class="string">&quot;Canvas&quot;</span>);</span><br><span class="line">		Transform panel = canvas.Find(<span class="string">&quot;Panel&quot;</span>);</span><br><span class="line">		Transform tip = canvas.Find(<span class="string">&quot;Tip&quot;</span>);</span><br><span class="line">		layers.Add(Layer.Panel, panel);</span><br><span class="line">		layers.Add(Layer.Tip, tip);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//打开面板</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Open</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] para</span>) <span class="keyword">where</span> T:BasePanel</span>&#123;</span><br><span class="line">		<span class="comment">//已经打开</span></span><br><span class="line">		<span class="built_in">string</span> name = <span class="keyword">typeof</span>(T).ToString();</span><br><span class="line">		<span class="keyword">if</span> (panels.ContainsKey(name))&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//组件</span></span><br><span class="line">		BasePanel panel = root.gameObject.AddComponent&lt;T&gt;();</span><br><span class="line">		panel.OnInit(); <span class="comment">//调用新生成的面板类的方法,OnInit由面板来实现,Init在面板基类当中实现,会根据面板的skinPath将面板资源实例化到场景中.</span></span><br><span class="line">		panel.Init(); <span class="comment">//注意这里调用的是BasePanel的Init方法,不是这里的Init方法</span></span><br><span class="line">		<span class="comment">//父容器</span></span><br><span class="line">		Transform layer = layers[panel.layer];</span><br><span class="line">		panel.skin.transform.SetParent(layer, <span class="literal">false</span>); <span class="comment">//关于SetParent的介绍如下:https://docs.unity.cn/cn/current/ScriptReference/Transform.SetParent.html</span></span><br><span class="line">        <span class="comment">//这里是false表示放弃原来的世界坐标位置,以layer为父节点                                              </span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//列表</span></span><br><span class="line">        panels.Add(name, panel);</span><br><span class="line">		<span class="comment">//OnShow</span></span><br><span class="line">		panel.OnShow(para);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭面板</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Close</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>&#123;</span><br><span class="line">		<span class="comment">//没有打开</span></span><br><span class="line">		<span class="keyword">if</span>(!panels.ContainsKey(name))&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		BasePanel panel = panels[name];</span><br><span class="line"></span><br><span class="line">		<span class="comment">//OnClose</span></span><br><span class="line">		panel.OnClose();</span><br><span class="line">		<span class="comment">//列表</span></span><br><span class="line">		panels.Remove(name);</span><br><span class="line">		<span class="comment">//销毁</span></span><br><span class="line">		GameObject.Destroy(panel.skin);</span><br><span class="line">		Component.Destroy(panel);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一些针对上述代码的说明:</p>
<p>(1)界面管理器的Init函数负责给root,canvas和layers复制,<strong>Init是初始化方法,需要在外部进行调用</strong>.</p>
<p>(2)Open函数的写法要求打开的面板必须要继承于BasePanel类,否则无法打开(<strong>通过where语句来进行控制</strong>)</p>
<p>(3)关于BasePanel的Init方法,它会根据面板的skinPath将面板资源实例化到场景中.程序再通过SetParent方法将面板皮肤放到设定的层级之下.</p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508111050807.png" alt="image-20220508111050807"></p>
<p>(4)请注意,这个类并不继承于MonoBehavior,这是因为继承于MonoBehavior的类是不允许通过new来创建的.详见:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/alexhu2010q/article/details/106695166">(11条消息) Unity的坑——避免用New来创建继承于MonoBehaviour脚本的对象_弹吉他的小刘鸭的博客-CSDN博客_unity銝要ew</a></p>
<p><strong>接下来便是手写具体的面板类了,这样就能够看出展现出的界面</strong></p>
<br/>

<h1 id="二-登录注册系统"><a href="#二-登录注册系统" class="headerlink" title="二.登录注册系统"></a>二.登录注册系统</h1><p>这里要写两个Panel类,分别是登录系统和注册系统(因为这是两个不同的面板)</p>
<h2 id="1-登录面板"><a href="#1-登录面板" class="headerlink" title="1.登录面板"></a>1.登录面板</h2><p>思路如下:</p>
<ul>
<li>登录面板包括”用户名”和”密码”两个输入框,以及登录和注册两个按钮,玩家输入用户名和密码之后,点击登录按钮,客户端会向服务器发送MsgLogin协议,点击”注册”按钮会打开注册面板;</li>
</ul>
<p>首先设计一个界面(由于是demo开发,因此这里采用比较朴素的界面即可,<strong>设计完界面之后,方便起见将其保存为预制体,这样后面还可以继续使用</strong>)</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508112947275.png" alt="image-20220508112947275"></p>
<h3 id="1-补充-关于密码框的设置"><a href="#1-补充-关于密码框的设置" class="headerlink" title="(1)补充:关于密码框的设置:"></a>(1)补充:关于密码框的设置:</h3><p>如果想让输入的内容显示密码的形式,则可以这样修改:</p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508113049214.png" alt="image-20220508113049214"></p>
<br/>

<h3 id="2-LoginPanel类的设计"><a href="#2-LoginPanel类的设计" class="headerlink" title="(2)LoginPanel类的设计"></a>(2)LoginPanel类的设计</h3><p>这个类用来写代码实现登录界面的功能.暂时书写如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoginPanel</span> : <span class="title">BasePanel</span> &#123;</span><br><span class="line">	<span class="comment">//账号输入框</span></span><br><span class="line">	<span class="keyword">private</span> InputField idInput;</span><br><span class="line">	<span class="comment">//密码输入框</span></span><br><span class="line">	<span class="keyword">private</span> InputField pwInput;</span><br><span class="line">	<span class="comment">//登陆按钮</span></span><br><span class="line">	<span class="keyword">private</span> Button loginBtn;</span><br><span class="line">	<span class="comment">//注册按钮</span></span><br><span class="line">	<span class="keyword">private</span> Button regBtn;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span> &#123;</span><br><span class="line">        <span class="comment">//设置皮肤地址skinPath和面板的层级layer</span></span><br><span class="line">		skinPath = <span class="string">&quot;LoginPanel&quot;</span>;</span><br><span class="line">		layer = PanelManager.Layer.Panel;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//显示</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span> &#123;</span><br><span class="line">		<span class="comment">//寻找组件</span></span><br><span class="line">		idInput = skin.transform.Find(<span class="string">&quot;IdInput&quot;</span>).GetComponent&lt;InputField&gt;();</span><br><span class="line">		pwInput = skin.transform.Find(<span class="string">&quot;PwInput&quot;</span>).GetComponent&lt;InputField&gt;();</span><br><span class="line">		loginBtn = skin.transform.Find(<span class="string">&quot;LoginBtn&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">		regBtn = skin.transform.Find(<span class="string">&quot;RegisterBtn&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">		<span class="comment">//监听:通过这种方式绑定监听,可以很好地进行预制体的移植.</span></span><br><span class="line">		loginBtn.onClick.AddListener(OnLoginClick);</span><br><span class="line">		regBtn.onClick.AddListener(OnRegClick);</span><br><span class="line">		<span class="comment">//网络协议监听</span></span><br><span class="line">		NetManager.AddMsgListener(<span class="string">&quot;MsgLogin&quot;</span>, OnMsgLogin);</span><br><span class="line">		<span class="comment">//网络事件监听</span></span><br><span class="line">		NetManager.AddEventListener(NetManager.NetEvent.ConnectSucc, OnConnectSucc);</span><br><span class="line">		NetManager.AddEventListener(NetManager.NetEvent.ConnectFail, OnConnectFail);</span><br><span class="line">		<span class="comment">//连接服务器</span></span><br><span class="line">		NetManager.Connect(<span class="string">&quot;47.111.176.71&quot;</span>, <span class="number">8888</span>); <span class="comment">//这个是服务器的公网地址以及对应的端口号</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span> &#123;</span><br><span class="line">		<span class="comment">//网络协议监听</span></span><br><span class="line">		NetManager.RemoveMsgListener(<span class="string">&quot;MsgLogin&quot;</span>, OnMsgLogin);</span><br><span class="line">		<span class="comment">//网络事件监听,NetEvent是自己定义的枚举类,如果需要其他事件的话也可以加进去</span></span><br><span class="line">		NetManager.RemoveEventListener(NetManager.NetEvent.ConnectSucc, OnConnectSucc);</span><br><span class="line">		NetManager.RemoveEventListener(NetManager.NetEvent.ConnectFail, OnConnectFail);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//连接成功回调</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnConnectSucc</span>(<span class="params"><span class="built_in">string</span> err</span>)</span>&#123;</span><br><span class="line">		Debug.Log(<span class="string">&quot;OnConnectSucc&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//连接失败回调</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnConnectFail</span>(<span class="params"><span class="built_in">string</span> err</span>)</span>&#123;</span><br><span class="line">		PanelManager.Open&lt;TipPanel&gt;(err);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//当按下注册按钮</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnRegClick</span>()</span> &#123;</span><br><span class="line">		PanelManager.Open&lt;RegisterPanel&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//当按下登陆按钮</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnLoginClick</span>()</span> &#123;</span><br><span class="line">		<span class="comment">//用户名密码为空</span></span><br><span class="line">		<span class="keyword">if</span> (idInput.text == <span class="string">&quot;&quot;</span> || pwInput.text == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">			PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;用户名和密码不能为空&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//发送</span></span><br><span class="line">		MsgLogin msgLogin = <span class="keyword">new</span> MsgLogin(); <span class="comment">//这里发送登录协议,协议本身要写在协议类的文件夹当中</span></span><br><span class="line">		msgLogin.id = idInput.text;</span><br><span class="line">		msgLogin.pw = pwInput.text;</span><br><span class="line">		NetManager.Send(msgLogin);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//收到登陆协议(这个是服务端回传回来的登录协议,客户端解析其中的内容)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgLogin</span> (<span class="params">MsgBase msgBase</span>)</span> &#123;</span><br><span class="line">		MsgLogin msg = (MsgLogin)msgBase;</span><br><span class="line">		<span class="keyword">if</span>(msg.result == <span class="number">0</span>)&#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;登陆成功&quot;</span>);</span><br><span class="line">			<span class="comment">//设置id</span></span><br><span class="line">			GameMain.id = msg.id;</span><br><span class="line">			<span class="comment">//打开房间列表界面</span></span><br><span class="line">			PanelManager.Open&lt;RoomListPanel&gt;();</span><br><span class="line">			<span class="comment">//关闭界面</span></span><br><span class="line">			Close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;登陆失败&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注:<strong>NetManager为网络管理的工具类,可以在本书的前面章节或者作者的个人Github主页找到(注意这个类也是不要继承于MonoBehavior的).</strong></p>
<p>其他说明:</p>
<p>(a)登录面板一般作为游戏的启动界面.当游戏启动时,客户端需要先连接服务端,后续才能收发协议.因此我们在OnShow方法当中发起网络连接,并添加对连接成功和连接失败的回调.这里还要添加对MsgLogin的监听,当客户端收到服务端发来的MsgLogin协议,会调用OnMsgLogin方法,<strong>当面板关闭时(OnClose),会删除OnShow中添加的监听.</strong></p>
<blockquote>
<p>如果想要让NetManager多一个监听的方法,则只需要在脚本当中调用类似NetManager.AddEventListener(NetManager.NetEvent.ConnectSucc, OnConnectSucc);的方法即可,其中OnConnectSucc的方法需要在调用NetManager.AddEventListener的类当中书写,如上.</p>
</blockquote>
<br/>

<h4 id="关于GameMain的说明"><a href="#关于GameMain的说明" class="headerlink" title="关于GameMain的说明"></a>关于GameMain的说明</h4><p>(b)GameMain是整个程序的主开始逻辑,会使得各个框架中的工具类开始工作:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameMain</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> id = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		<span class="comment">//网络监听</span></span><br><span class="line">		NetManager.AddEventListener(NetManager.NetEvent.Close, OnConnectClose);</span><br><span class="line">		NetManager.AddMsgListener(<span class="string">&quot;MsgKick&quot;</span>, OnMsgKick);</span><br><span class="line">		<span class="comment">//初始化</span></span><br><span class="line">		PanelManager.Init();</span><br><span class="line">		BattleManager.Init();</span><br><span class="line">		<span class="comment">//打开登陆面板</span></span><br><span class="line">		PanelManager.Open&lt;LoginPanel&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">		NetManager.Update();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭连接</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnConnectClose</span>(<span class="params"><span class="built_in">string</span> err</span>)</span>&#123;</span><br><span class="line">		Debug.Log(<span class="string">&quot;断开连接&quot;</span>);</span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">//被踢下线</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnMsgKick</span>(<span class="params">MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;被踢下线&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>GameMain会对网络框架NetManager进行每帧的调用,同时还会完成一些通用事件的处理,比如网络断开时弹出提示,玩家被踢下线时弹出提示.(<strong>该脚本可以挂载在Main Camera下</strong>)</p>
<p>同时,GameMain.id还可以缓存玩家的id信息,这样后续游戏过程当中也会比较方便.</p>
<p>GameMain类可以实现的功能如下:</p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508132903711.png" alt="image-20220508132903711"></p>
<br/>

<p>(c)由于我们要把协议打包成Json的格式发送给服务端,因此每一种协议都需要用类来表示,以方便Json的序列化,比如说上述代码中提及的MsgLogin协议,格式应该如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//登陆</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgLogin</span> : <span class="title">MsgBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MsgLogin</span>()</span> &#123; protoName = <span class="string">&quot;MsgLogin&quot;</span>; &#125;</span><br><span class="line">    <span class="comment">//客户端发</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> id = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> pw = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//服务端回（0-成功，1-失败）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="3-TipPanel的实现"><a href="#3-TipPanel的实现" class="headerlink" title="(3)TipPanel的实现"></a>(3)TipPanel的实现</h3><p>可以看到,在上面的代码当中,我们需要一个TipPanel类,接收字符串作为展示的信息,同时给予用户正确的提示信息,因此需要写这样一个TipPanel类.</p>
<p>首先,还是需要制作一个通用的TipPanel界面,以方便后续程序寻找其中的组件:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508121230629.png" alt="image-20220508121230629"></p>
<p>因此,通用类TipPanel可以书写如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TipPanel</span> : <span class="title">BasePanel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//提示文本</span></span><br><span class="line">    <span class="keyword">private</span> Text text;</span><br><span class="line">    <span class="comment">//确定按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button okBtn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        skinPath = <span class="string">&quot;TipPanel&quot;</span>;</span><br><span class="line">        layer = PanelManager.Layer.Tip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//显示</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//寻找组件</span></span><br><span class="line">        text = skin.transform.Find(<span class="string">&quot;Text&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        okBtn = skin.transform.Find(<span class="string">&quot;OkBtn&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        <span class="comment">//监听</span></span><br><span class="line">        okBtn.onClick.AddListener(OnOkClick);</span><br><span class="line">        <span class="comment">//提示语</span></span><br><span class="line">        <span class="keyword">if</span> (args.Length == <span class="number">1</span>) <span class="comment">//如果只传入了一个参数,那么就显示这个参数,这个是提示正文中显示的内容</span></span><br><span class="line">        &#123;</span><br><span class="line">            text.text = (<span class="built_in">string</span>)args[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当按下确定按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnOkClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Close(); <span class="comment">//这个调用基类BasePanel的Close方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="2-注册面板"><a href="#2-注册面板" class="headerlink" title="2.注册面板"></a>2.注册面板</h2><h3 id="1-RegisterPanel的设计"><a href="#1-RegisterPanel的设计" class="headerlink" title="(1)RegisterPanel的设计"></a>(1)RegisterPanel的设计</h3><p>这个是注册面板,首先也要对这个面板进行设计,设计结果如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508123043875.png" alt="image-20220508123043875"></p>
<p>同样,将面板设置成预制体,保存在Resources文件夹,以方便PanelManager来加载它.</p>
<p>注:可以通过设置输入长度的范围来限制用户起过长的名字(理论上对应代码逻辑也要写,不过这里为了方便就先不写了)</p>
<p><img src="D:/blog/source/_posts/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.assets/image-20220508132442166.png" alt="image-20220508132442166"></p>
<br/>

<h4 id="a-注册面板类的书写"><a href="#a-注册面板类的书写" class="headerlink" title="(a)注册面板类的书写"></a>(a)注册面板类的书写</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RegisterPanel</span> : <span class="title">BasePanel</span> &#123;</span><br><span class="line">	<span class="comment">//账号输入框</span></span><br><span class="line">	<span class="keyword">private</span> InputField idInput;</span><br><span class="line">	<span class="comment">//密码输入框</span></span><br><span class="line">	<span class="keyword">private</span> InputField pwInput;</span><br><span class="line">	<span class="comment">//重复输入框</span></span><br><span class="line">	<span class="keyword">private</span> InputField repInput;</span><br><span class="line">	<span class="comment">//注册按钮</span></span><br><span class="line">	<span class="keyword">private</span> Button regBtn;</span><br><span class="line">	<span class="comment">//关闭按钮</span></span><br><span class="line">	<span class="keyword">private</span> Button closeBtn;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span> &#123;</span><br><span class="line">		skinPath = <span class="string">&quot;RegisterPanel&quot;</span>;</span><br><span class="line">		layer = PanelManager.Layer.Panel;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//显示</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span> &#123;</span><br><span class="line">		<span class="comment">//寻找组件</span></span><br><span class="line">		idInput = skin.transform.Find(<span class="string">&quot;IdInput&quot;</span>).GetComponent&lt;InputField&gt;();</span><br><span class="line">		pwInput = skin.transform.Find(<span class="string">&quot;PwInput&quot;</span>).GetComponent&lt;InputField&gt;();</span><br><span class="line">		repInput = skin.transform.Find(<span class="string">&quot;RepInput&quot;</span>).GetComponent&lt;InputField&gt;();</span><br><span class="line">		regBtn = skin.transform.Find(<span class="string">&quot;RegisterBtn&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">		closeBtn = skin.transform.Find(<span class="string">&quot;CloseBtn&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">		<span class="comment">//监听</span></span><br><span class="line">		regBtn.onClick.AddListener(OnRegClick);</span><br><span class="line">		closeBtn.onClick.AddListener(OnCloseClick);</span><br><span class="line">		<span class="comment">//网络协议监听</span></span><br><span class="line">		NetManager.AddMsgListener(<span class="string">&quot;MsgRegister&quot;</span>, OnMsgRegister);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span> &#123;</span><br><span class="line">		<span class="comment">//网络协议监听</span></span><br><span class="line">		NetManager.RemoveMsgListener(<span class="string">&quot;MsgRegister&quot;</span>, OnMsgRegister);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//当按下注册按钮</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnRegClick</span>()</span> &#123;</span><br><span class="line">		<span class="comment">//用户名密码为空</span></span><br><span class="line">		<span class="keyword">if</span> (idInput.text == <span class="string">&quot;&quot;</span> || pwInput.text == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">			PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;用户名和密码不能为空&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//两次密码不同</span></span><br><span class="line">		<span class="keyword">if</span> (repInput.text != pwInput.text) &#123;</span><br><span class="line">			PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;两次输入的密码不同&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//发送</span></span><br><span class="line">		MsgRegister msgReg = <span class="keyword">new</span> MsgRegister();</span><br><span class="line">		msgReg.id = idInput.text;</span><br><span class="line">		msgReg.pw = pwInput.text;</span><br><span class="line">		NetManager.Send(msgReg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//收到注册协议</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgRegister</span> (<span class="params">MsgBase msgBase</span>)</span> &#123;</span><br><span class="line">		MsgRegister msg = (MsgRegister)msgBase;</span><br><span class="line">		<span class="keyword">if</span>(msg.result == <span class="number">0</span>)&#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;注册成功&quot;</span>);</span><br><span class="line">			<span class="comment">//提示</span></span><br><span class="line">			PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;注册成功&quot;</span>);</span><br><span class="line">			<span class="comment">//关闭界面</span></span><br><span class="line">			Close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;注册失败&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//当按下关闭按钮</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCloseClick</span>()</span> &#123;</span><br><span class="line">		Close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关于MsgRegister协议,书写如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgRegister</span> : <span class="title">MsgBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MsgRegister</span>()</span> &#123; protoName = <span class="string">&quot;MsgRegister&quot;</span>; &#125;</span><br><span class="line">    <span class="comment">//客户端发</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> id = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> pw = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//服务端回（0-成功，1-失败）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br/>经过测试,登录和注册面板的功能可以实现.测试环节包括:</p>
<ul>
<li>测试错误的账号&#x2F;密码</li>
<li>测试非法账号&#x2F;密码</li>
<li>测试正确账号密码登录</li>
<li>测试正常注册</li>
<li>测试重复用户注册</li>
<li>测试非法账号&#x2F;密码注册</li>
<li>测试登录同一账号,正常会把另一个同账号在线的用户踢掉.</li>
</ul>
<br/>

<h1 id="三-房间系统"><a href="#三-房间系统" class="headerlink" title="三.房间系统"></a>三.房间系统</h1><h2 id="1-整体结构"><a href="#1-整体结构" class="headerlink" title="1.整体结构"></a>1.整体结构</h2><p>首先,再次回顾之间做的房间列表系统的整体结构:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508134308817.png" alt="image-20220508134308817"></p>
<p>以及房间内部匹配的时候的结构:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508134621965.png" alt="image-20220508134621965"></p>
<br/>

<h2 id="2-协议设计"><a href="#2-协议设计" class="headerlink" title="2.协议设计"></a>2.协议设计</h2><p>打开房间列表面板后,面板左侧显示玩家的战绩,因此需要定义查询战绩的协议<code>MsgGetAchieve</code>,而面板右侧显示了房间列表,需要获取房间列表的协议<code>MsgGetRoomList</code>,面板中有加入,加入房间,创建房间和刷新按钮,涉及<code>MsgCreateRoom</code>,<code>MsgEnterRoom</code>两条协议,如果玩家进入房间,需要获取房间信息:<code>MsgGetRoomInfo</code>,玩家还可以选择离开房间(<code>MsgLeaveRoom</code>或者准备开始战斗<code>MsgStartBattle</code>)综上,需要设计房间系统协议类<code>RoomMsg</code>.</p>
<p>将其放置在proto协议类文件夹下.</p>
<p>这个脚本涉及到的协议如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询成绩</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgGetAchieve</span>:<span class="title">MsgBase</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MsgGetAchieve</span>()</span> &#123;protoName = <span class="string">&quot;MsgGetAchieve&quot;</span>;&#125;</span><br><span class="line">	<span class="comment">//服务端回</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> win = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> lost = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//房间信息,需要加上这个表示是可序列化的,否则Unity的JsonUtility无法正确的解析rooms数组</span></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoomInfo</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> id = <span class="number">0</span>;		<span class="comment">//房间id</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> count = <span class="number">0</span>;	<span class="comment">//人数</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> status = <span class="number">0</span>;	<span class="comment">//状态0-准备中 1-战斗中</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//请求房间列表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgGetRoomList</span>:<span class="title">MsgBase</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MsgGetRoomList</span>()</span> &#123;protoName = <span class="string">&quot;MsgGetRoomList&quot;</span>;&#125;</span><br><span class="line">	<span class="comment">//服务端回</span></span><br><span class="line">	<span class="keyword">public</span> RoomInfo[] rooms;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建房间</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgCreateRoom</span>:<span class="title">MsgBase</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MsgCreateRoom</span>()</span> &#123;protoName = <span class="string">&quot;MsgCreateRoom&quot;</span>;&#125;</span><br><span class="line">	<span class="comment">//服务端回</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入房间</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgEnterRoom</span>:<span class="title">MsgBase</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MsgEnterRoom</span>()</span> &#123;protoName = <span class="string">&quot;MsgEnterRoom&quot;</span>;&#125;</span><br><span class="line">	<span class="comment">//客户端发</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> id = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//服务端回</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//玩家信息</span></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerInfo</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> id = <span class="string">&quot;ChrisZhang&quot;</span>;	<span class="comment">//账号</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> camp = <span class="number">0</span>;		<span class="comment">//阵营,在我们的游戏里可以表示使用哪种动物</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> win = <span class="number">0</span>;			<span class="comment">//胜利数</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> lost = <span class="number">0</span>;		<span class="comment">//失败数</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> isOwner = <span class="number">0</span>;		<span class="comment">//是否是房主</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取房间信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgGetRoomInfo</span>:<span class="title">MsgBase</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MsgGetRoomInfo</span>()</span> &#123;protoName = <span class="string">&quot;MsgGetRoomInfo&quot;</span>;&#125;</span><br><span class="line">	<span class="comment">//服务端回</span></span><br><span class="line">	<span class="keyword">public</span> PlayerInfo[] players;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//离开房间</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgLeaveRoom</span>:<span class="title">MsgBase</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MsgLeaveRoom</span>()</span> &#123;protoName = <span class="string">&quot;MsgLeaveRoom&quot;</span>;&#125;</span><br><span class="line">	<span class="comment">//服务端回</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开战</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgStartBattle</span>:<span class="title">MsgBase</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MsgStartBattle</span>()</span> &#123;protoName = <span class="string">&quot;MsgStartBattle&quot;</span>;&#125;</span><br><span class="line">	<span class="comment">//服务端回</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注:</p>
<p>(1)<code>[System.Serializable]</code>表示该类可以被序列化,有的时候需要在类前加入这个信息,否则无法序列化为Json格式.</p>
<br/>

<h2 id="3-列表面板逻辑"><a href="#3-列表面板逻辑" class="headerlink" title="3.列表面板逻辑"></a>3.列表面板逻辑</h2><p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508135859805.png" alt="image-20220508135859805"></p>
<h3 id="1-面板类RoomListPanel"><a href="#1-面板类RoomListPanel" class="headerlink" title="(1)面板类RoomListPanel"></a>(1)面板类RoomListPanel</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoomListPanel</span> : <span class="title">BasePanel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//账号文本</span></span><br><span class="line">    <span class="keyword">private</span> Text idText;</span><br><span class="line">    <span class="comment">//战绩文本</span></span><br><span class="line">    <span class="keyword">private</span> Text scoreText;</span><br><span class="line">    <span class="comment">//创建房间按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button createButton;</span><br><span class="line">    <span class="comment">//刷新列表按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button reflashButton;</span><br><span class="line">    <span class="comment">//加入房间按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button enterButton;</span><br><span class="line">    <span class="comment">//列表容器</span></span><br><span class="line">    <span class="keyword">private</span> Transform content;</span><br><span class="line">    <span class="comment">//房间物体</span></span><br><span class="line">    <span class="keyword">private</span> GameObject roomObj;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        skinPath = <span class="string">&quot;RoomListPanel&quot;</span>;</span><br><span class="line">        layer = PanelManager.Layer.Panel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//显示</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//寻找组件</span></span><br><span class="line">        idText = skin.transform.Find(<span class="string">&quot;InfoPanel/IdText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        scoreText = skin.transform.Find(<span class="string">&quot;InfoPanel/ScoreText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        createButton = skin.transform.Find(<span class="string">&quot;CtrlPanel/CreateButton&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        reflashButton = skin.transform.Find(<span class="string">&quot;CtrlPanel/ReflashButton&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        enterButton = skin.transform.Find(<span class="string">&quot;CtrlPanel/GetInButton&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        content = skin.transform.Find(<span class="string">&quot;ListPanel/Scroll View/Viewport/Content&quot;</span>);</span><br><span class="line">        roomObj = skin.transform.Find(<span class="string">&quot;Room&quot;</span>).gameObject;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//刚进入的时候不激活房间</span></span><br><span class="line">        roomObj.SetActive(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//显示id</span></span><br><span class="line">        idText.text = GameMain.id;</span><br><span class="line">        <span class="comment">//按钮事件</span></span><br><span class="line">        createButton.onClick.AddListener(OnCreateClick);</span><br><span class="line">        reflashButton.onClick.AddListener(OnReflashClick);</span><br><span class="line">        enterButton.onClick.AddListener(OnEnterClick);</span><br><span class="line">        <span class="comment">//协议监听</span></span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgGetAchieve&quot;</span>, OnMsgGetAchieve);</span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgGetRoomList&quot;</span>, OnMsgGetRoomList);</span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgCreateRoom&quot;</span>, OnMsgCreateRoom);</span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgEnterRoom&quot;</span>, OnMsgEnterRoom);</span><br><span class="line">        <span class="comment">//发送查询</span></span><br><span class="line">        MsgGetAchieve msgGetAchieve = <span class="keyword">new</span> MsgGetAchieve();</span><br><span class="line">        NetManager.Send(msgGetAchieve);</span><br><span class="line">        MsgGetRoomList msgGetRoomList = <span class="keyword">new</span> MsgGetRoomList();</span><br><span class="line">        NetManager.Send(msgGetRoomList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//协议监听</span></span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgGetAchieve&quot;</span>, OnMsgGetAchieve);</span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgGetRoomList&quot;</span>, OnMsgGetRoomList);</span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgCreateRoom&quot;</span>, OnMsgCreateRoom);</span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgEnterRoom&quot;</span>, OnMsgEnterRoom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到成绩查询协议</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgGetAchieve</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgGetAchieve msg = (MsgGetAchieve)msgBase;</span><br><span class="line">        scoreText.text = msg.win + <span class="string">&quot;胜 &quot;</span> + msg.lost + <span class="string">&quot;负&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到房间列表协议</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgGetRoomList</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgGetRoomList msg = (MsgGetRoomList)msgBase;</span><br><span class="line">        <span class="comment">//清除房间列表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = content.childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject o = content.GetChild(i).gameObject;</span><br><span class="line">            Destroy(o);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重新生成列表</span></span><br><span class="line">        <span class="keyword">if</span> (msg.rooms == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; msg.rooms.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            GenerateRoom(msg.rooms[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个房间单元,这是根据服务端传回来的信息新建房间列表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GenerateRoom</span>(<span class="params">RoomInfo roomInfo</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建物体</span></span><br><span class="line">        GameObject o = Instantiate(roomObj);</span><br><span class="line">        o.transform.SetParent(content,<span class="literal">false</span>); <span class="comment">//这里千万不要忘了false</span></span><br><span class="line">        o.SetActive(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//获取组件</span></span><br><span class="line">        Transform trans = o.transform;</span><br><span class="line">        Text idText = trans.Find(<span class="string">&quot;IdText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        Text countText = trans.Find(<span class="string">&quot;CountText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        Text statusText = trans.Find(<span class="string">&quot;StatusText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        Button btn = trans.Find(<span class="string">&quot;JoinButton&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        <span class="comment">//填充信息</span></span><br><span class="line">        idText.text = roomInfo.id.ToString();</span><br><span class="line">        countText.text = roomInfo.count.ToString();</span><br><span class="line">        <span class="keyword">if</span> (roomInfo.status == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            statusText.text = <span class="string">&quot;准备中&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            statusText.text = <span class="string">&quot;战斗中&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//按钮事件</span></span><br><span class="line">        btn.name = idText.text;</span><br><span class="line">        btn.onClick.AddListener(<span class="built_in">delegate</span> () &#123;  <span class="comment">// 比较巧的是这个,可以给按钮绑定监听函数,按钮的名字就是房间的id号,这样点击的时候就可以直接访问房间信息了.</span></span><br><span class="line">            OnJoinClick(btn.name);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//点击左侧加入房间按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnEnterClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点击刷新按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnReflashClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgGetRoomList msg = <span class="keyword">new</span> MsgGetRoomList();</span><br><span class="line">        NetManager.Send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点击加入房间按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnJoinClick</span>(<span class="params"><span class="built_in">string</span> idString</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgEnterRoom msg = <span class="keyword">new</span> MsgEnterRoom();</span><br><span class="line">        msg.id = <span class="built_in">int</span>.Parse(idString);</span><br><span class="line">        NetManager.Send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到进入房间协议</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgEnterRoom</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgEnterRoom msg = (MsgEnterRoom)msgBase;</span><br><span class="line">        <span class="comment">//成功进入房间</span></span><br><span class="line">        <span class="keyword">if</span> (msg.result == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;RoomPanel&gt;();</span><br><span class="line">            Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进入房间失败</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;进入房间失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点击新建房间按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCreateClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgCreateRoom msg = <span class="keyword">new</span> MsgCreateRoom();<span class="comment">//根据服务端代码,创建成功会自动设定房主</span></span><br><span class="line">        NetManager.Send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到新建房间协议</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgCreateRoom</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgCreateRoom msg = (MsgCreateRoom)msgBase;</span><br><span class="line">        <span class="comment">//成功创建房间</span></span><br><span class="line">        <span class="keyword">if</span> (msg.result == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;创建成功&quot;</span>);</span><br><span class="line">            PanelManager.Open&lt;RoomPanel&gt;();</span><br><span class="line">            Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建房间失败</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;创建房间失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="2-房间类RoomPanel"><a href="#2-房间类RoomPanel" class="headerlink" title="(2)房间类RoomPanel"></a>(2)房间类RoomPanel</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoomPanel</span> : <span class="title">BasePanel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//开战按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button startButton;</span><br><span class="line">    <span class="comment">//退出按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button closeButton;</span><br><span class="line">    <span class="comment">//列表容器</span></span><br><span class="line">    <span class="keyword">private</span> Transform content;</span><br><span class="line">    <span class="comment">//玩家信息物体</span></span><br><span class="line">    <span class="keyword">private</span> GameObject playerObj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        skinPath = <span class="string">&quot;RoomPanel&quot;</span>;</span><br><span class="line">        layer = PanelManager.Layer.Panel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//显示</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//寻找组件</span></span><br><span class="line">        startButton = skin.transform.Find(<span class="string">&quot;CtrlPanel/StartButton&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        closeButton = skin.transform.Find(<span class="string">&quot;CtrlPanel/CloseButton&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        content = skin.transform.Find(<span class="string">&quot;ListPanel/Scroll View/Viewport/Content&quot;</span>);</span><br><span class="line">        playerObj = skin.transform.Find(<span class="string">&quot;Player&quot;</span>).gameObject;</span><br><span class="line">        <span class="comment">//不激活玩家信息</span></span><br><span class="line">        playerObj.SetActive(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//按钮事件</span></span><br><span class="line">        startButton.onClick.AddListener(OnStartClick);</span><br><span class="line">        closeButton.onClick.AddListener(OnCloseClick);</span><br><span class="line">        <span class="comment">//协议监听</span></span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgGetRoomInfo&quot;</span>, OnMsgGetRoomInfo);</span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgLeaveRoom&quot;</span>, OnMsgLeaveRoom);</span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgStartBattle&quot;</span>, OnMsgStartBattle);</span><br><span class="line">        <span class="comment">//发送查询</span></span><br><span class="line">        MsgGetRoomInfo msg = <span class="keyword">new</span> MsgGetRoomInfo();</span><br><span class="line">        NetManager.Send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//协议监听</span></span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgGetRoomInfo&quot;</span>, OnMsgGetRoomInfo);</span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgLeaveRoom&quot;</span>, OnMsgLeaveRoom);</span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgStartBattle&quot;</span>, OnMsgStartBattle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到玩家列表协议</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgGetRoomInfo</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgGetRoomInfo msg = (MsgGetRoomInfo)msgBase;</span><br><span class="line">        <span class="comment">//清除玩家列表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = content.childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject o = content.GetChild(i).gameObject;</span><br><span class="line">            Destroy(o);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重新生成列表</span></span><br><span class="line">        <span class="keyword">if</span> (msg.players == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; msg.players.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            GeneratePlayerInfo(msg.players[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个玩家信息单元</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GeneratePlayerInfo</span>(<span class="params">PlayerInfo playerInfo</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建物体</span></span><br><span class="line">        GameObject o = Instantiate(playerObj);</span><br><span class="line">        o.transform.SetParent(content,<span class="literal">false</span>); <span class="comment">//这里务必设置成false否则会有bug</span></span><br><span class="line">        o.SetActive(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//获取组件</span></span><br><span class="line">        Transform trans = o.transform;</span><br><span class="line">        Text idText = trans.Find(<span class="string">&quot;IdText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        Text campText = trans.Find(<span class="string">&quot;CampText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        Text scoreText = trans.Find(<span class="string">&quot;ScoreText&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        <span class="comment">//填充信息</span></span><br><span class="line">        idText.text = playerInfo.id;</span><br><span class="line">        <span class="keyword">if</span> (playerInfo.camp == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            campText.text = <span class="string">&quot;红&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            campText.text = <span class="string">&quot;蓝&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (playerInfo.isOwner == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            campText.text = campText.text + <span class="string">&quot; ！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        scoreText.text = playerInfo.win + <span class="string">&quot;胜 &quot;</span> + playerInfo.lost + <span class="string">&quot;负&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点击退出按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCloseClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgLeaveRoom msg = <span class="keyword">new</span> MsgLeaveRoom();</span><br><span class="line">        NetManager.Send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到退出房间协议</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgLeaveRoom</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgLeaveRoom msg = (MsgLeaveRoom)msgBase;</span><br><span class="line">        <span class="comment">//成功退出房间</span></span><br><span class="line">        <span class="keyword">if</span> (msg.result == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;退出房间&quot;</span>);</span><br><span class="line">            PanelManager.Open&lt;RoomListPanel&gt;();</span><br><span class="line">            Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//退出房间失败</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;退出房间失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点击开战按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnStartClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgStartBattle msg = <span class="keyword">new</span> MsgStartBattle();</span><br><span class="line">        NetManager.Send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到开战返回</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgStartBattle</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgStartBattle msg = (MsgStartBattle)msgBase;</span><br><span class="line">        <span class="comment">//开战</span></span><br><span class="line">        <span class="keyword">if</span> (msg.result == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//关闭界面</span></span><br><span class="line">            Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//开战失败</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;开战失败！两队至少都需要一名玩家，只有队长可以开始战斗！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="4-关于保存预制体的细节-容易出错"><a href="#4-关于保存预制体的细节-容易出错" class="headerlink" title="4.关于保存预制体的细节(容易出错!)"></a>4.关于保存预制体的细节(容易出错!)</h2><p>值得注意的是,根据上述的代码,预制体当中要提前存有一个Player和Room,如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508175241428.png" alt="image-20220508175241428"></p>
<p>(上图标注位置有一些问题,应该是最下面的那个Room是提前存的)</p>
<h1 id="四-服务端玩家数据"><a href="#四-服务端玩家数据" class="headerlink" title="四.服务端玩家数据"></a>四.服务端玩家数据</h1><p>几个要点:</p>
<ul>
<li>PlayerData当中存放要存储数据库的信息</li>
<li>Player类当中存放游戏需要的临时数据信息,比如玩家的动物,位置,道具,roomID等信息</li>
</ul>
<p>总的来说,客户端的clientState的结构如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508181103014.png" alt="image-20220508181103014"></p>
<h1 id="五-服务端房间类"><a href="#五-服务端房间类" class="headerlink" title="五.服务端房间类"></a>五.服务端房间类</h1><p>在服务端,每一个房间是一个Room类对象,由RoomManager来统一管理添加和删除.因此,服务端的逻辑代码中需要包括<code>Room.cs</code>和<code>RoomManager.cs</code>,同时也需要客户端的<code>RoomMsg.cs</code>协议文件.</p>
<h2 id="1-房间类的设计要点"><a href="#1-房间类的设计要点" class="headerlink" title="1.房间类的设计要点"></a>1.房间类的设计要点</h2><p>房间类要保罗房间id,玩家列表,房主信息,房间状态.Room类定义如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Room</span> &#123;</span><br><span class="line">	<span class="comment">//id</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> id = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//最大玩家数</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> maxPlayer = <span class="number">8</span>;</span><br><span class="line">	<span class="comment">//玩家列表</span></span><br><span class="line">	<span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt; playerIds = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt;();</span><br><span class="line">	<span class="comment">//房主id</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> ownerId = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="comment">//状态</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">enum</span> Status &#123;</span><br><span class="line">		PREPARE = <span class="number">0</span>,</span><br><span class="line">		FIGHT = <span class="number">1</span> ,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> Status status = Status.PREPARE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-添加玩家"><a href="#1-添加玩家" class="headerlink" title="(1)添加玩家"></a>(1)添加玩家</h3><p>当玩家创建房间或进入一个已经存在的房间时,程序需要把这个玩家添加到房间里,也就是在Room对象的playerIds列表中添加一项,对应玩家的id.同时为了方便索引,<strong>还会设置Player对象的roomId属性</strong>,也就是说玩家和房间是互相索引的关系.</p>
<p>在房间类中定义添加玩家的方法AddPlayer:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加玩家</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddPlayer</span>(<span class="params"><span class="built_in">string</span> id</span>)</span>&#123;</span><br><span class="line">		<span class="comment">//获取玩家</span></span><br><span class="line">		Player player = PlayerManager.GetPlayer(id);</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>)&#123;</span><br><span class="line">			Console.WriteLine(<span class="string">&quot;room.AddPlayer fail, player is null&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//房间人数</span></span><br><span class="line">		<span class="keyword">if</span>(playerIds.Count &gt;= maxPlayer)&#123;</span><br><span class="line">			Console.WriteLine(<span class="string">&quot;room.AddPlayer fail, reach maxPlayer&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//准备状态才能加人</span></span><br><span class="line">		<span class="keyword">if</span>(status != Status.PREPARE)&#123;</span><br><span class="line">			Console.WriteLine(<span class="string">&quot;room.AddPlayer fail, not PREPARE&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//已经在房间里</span></span><br><span class="line">		<span class="keyword">if</span>(playerIds.ContainsKey(id))&#123;</span><br><span class="line">			Console.WriteLine(<span class="string">&quot;room.AddPlayer fail, already in this room&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//加入列表</span></span><br><span class="line">		playerIds[id] = <span class="literal">true</span>;</span><br><span class="line">		<span class="comment">//设置玩家数据</span></span><br><span class="line">		player.camp = SwitchCamp(); <span class="comment">//为玩家选择阵营,后续可以设置让玩家能够自选阵营</span></span><br><span class="line">		player.roomId = <span class="keyword">this</span>.id;</span><br><span class="line">		<span class="comment">//设置房主,这行代码会使第一个进入房间的人成为房主.</span></span><br><span class="line">		<span class="keyword">if</span>(ownerId == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			ownerId = player.id;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//广播</span></span><br><span class="line">		Broadcast(ToMsg());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>服务端中管理器,房间,玩家之间的索引关系:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508195422297.png" alt="image-20220508195422297"></p>
<h3 id="2-删除玩家"><a href="#2-删除玩家" class="headerlink" title="(2)删除玩家"></a>(2)删除玩家</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除玩家</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemovePlayer</span>(<span class="params"><span class="built_in">string</span> id</span>)</span> &#123;</span><br><span class="line">		<span class="comment">//获取玩家</span></span><br><span class="line">		Player player = PlayerManager.GetPlayer(id);</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>)&#123;</span><br><span class="line">			Console.WriteLine(<span class="string">&quot;room.RemovePlayer fail, player is null&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//没有在房间里</span></span><br><span class="line">		<span class="keyword">if</span>(!playerIds.ContainsKey(id))&#123;</span><br><span class="line">			Console.WriteLine(<span class="string">&quot;room.RemovePlayer fail, not in this room&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//删除列表</span></span><br><span class="line">		playerIds.Remove(id);</span><br><span class="line">		<span class="comment">//设置玩家数据</span></span><br><span class="line">		player.camp = <span class="number">0</span>;</span><br><span class="line">		player.roomId = <span class="number">-1</span>;</span><br><span class="line">		<span class="comment">//设置房主(如果说房主离开了房间,则需要重新设置房主)</span></span><br><span class="line">		<span class="keyword">if</span>(ownerId == player.id)&#123;</span><br><span class="line">			ownerId = SwitchOwner();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//战斗状态退出</span></span><br><span class="line">		<span class="keyword">if</span>(status == Status.FIGHT)&#123;</span><br><span class="line">			player.data.lost++; <span class="comment">//判定玩家失败</span></span><br><span class="line">			<span class="comment">//MsgLeaveBattle msg = new MsgLeaveBattle(); //这些逻辑暂时不需要</span></span><br><span class="line">			<span class="comment">//msg.id = player.id;</span></span><br><span class="line">			<span class="comment">//Broadcast(msg);</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//房间为空,则房间管理器销毁这个房间</span></span><br><span class="line">		<span class="keyword">if</span>(playerIds.Count == <span class="number">0</span>)&#123;</span><br><span class="line">			RoomManager.RemoveRoom(<span class="keyword">this</span>.id);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//广播</span></span><br><span class="line">		Broadcast(ToMsg());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>其中,筛选新的房主的方法如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//选择房主</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">SwitchOwner</span>()</span> &#123;</span><br><span class="line">		<span class="comment">//选择第一个玩家</span></span><br><span class="line">		<span class="keyword">foreach</span>(<span class="built_in">string</span> id <span class="keyword">in</span> playerIds.Keys) &#123;</span><br><span class="line">			<span class="keyword">return</span> id;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//房间没人</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>广播消息的函数如下(<strong>这个函数也可以用来后续对房间里的玩家广播最新的房间信息</strong>):</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//广播消息</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Broadcast</span>(<span class="params">MsgBase msg</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="built_in">string</span> id <span class="keyword">in</span> playerIds.Keys) &#123;</span><br><span class="line">			Player player = PlayerManager.GetPlayer(id);</span><br><span class="line">			player.Send(msg);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-生成房间信息"><a href="#3-生成房间信息" class="headerlink" title="(3)生成房间信息"></a>(3)生成房间信息</h3><p>这里需要用到<code>ToMsg</code>函数,该函数会遍历playersId列表,逐个填充玩家信息,包括账号,阵营,胜利失败数和是否为房主.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成MsgGetRoomInfo协议</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MsgBase <span class="title">ToMsg</span>()</span>&#123;</span><br><span class="line">		MsgGetRoomInfo msg = <span class="keyword">new</span> MsgGetRoomInfo();</span><br><span class="line">		<span class="built_in">int</span> count = playerIds.Count;</span><br><span class="line">		msg.players = <span class="keyword">new</span> PlayerInfo[count]; <span class="comment">//服务端要回复给客户端的内容</span></span><br><span class="line">		<span class="comment">//players</span></span><br><span class="line">		<span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="built_in">string</span> id <span class="keyword">in</span> playerIds.Keys)&#123;</span><br><span class="line">			Player player = PlayerManager.GetPlayer(id);</span><br><span class="line">			PlayerInfo playerInfo = <span class="keyword">new</span> PlayerInfo();</span><br><span class="line">			<span class="comment">//赋值</span></span><br><span class="line">			playerInfo.id = player.id;</span><br><span class="line">			playerInfo.camp = player.camp;</span><br><span class="line">			playerInfo.win = player.data.win;</span><br><span class="line">			playerInfo.lost = player.data.lost;</span><br><span class="line">			playerInfo.isOwner = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span>(isOwner(player))&#123;</span><br><span class="line">				playerInfo.isOwner = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			msg.players[i] = playerInfo;</span><br><span class="line">			i++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> msg;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h1 id="六-服务端房间管理器"><a href="#六-服务端房间管理器" class="headerlink" title="六.服务端房间管理器"></a>六.服务端房间管理器</h1><ul>
<li>这个管理器的核心内容是一个名为rooms的列表(类型为<code>Dictionary&lt;int,Room&gt;</code>类型).成员maxId的功能是给房间分配一个唯一的id,每当创建新房间,maxId+&#x3D;1;</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoomManager</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//最大id</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> maxId = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">//房间列表</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">int</span>, Room&gt; rooms = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, Room&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建房间</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Room <span class="title">AddRoom</span>()</span>&#123;</span><br><span class="line">		maxId++;</span><br><span class="line">		Room room = <span class="keyword">new</span> Room();</span><br><span class="line">		room.id = maxId;</span><br><span class="line">		rooms.Add(room.id, room);</span><br><span class="line">		<span class="keyword">return</span> room;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//删除房间</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">RemoveRoom</span>(<span class="params"><span class="built_in">int</span> id</span>)</span> &#123;</span><br><span class="line">		rooms.Remove(id);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取房间</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Room <span class="title">GetRoom</span>(<span class="params"><span class="built_in">int</span> id</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(rooms.ContainsKey(id))&#123;</span><br><span class="line">			<span class="keyword">return</span> rooms[id];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//生成MsgGetRoomList协议,该协议会把所有的房间信息打包成报文</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MsgBase <span class="title">ToMsg</span>()</span>&#123;</span><br><span class="line">		MsgGetRoomList msg = <span class="keyword">new</span> MsgGetRoomList();</span><br><span class="line">		<span class="built_in">int</span> count = rooms.Count;</span><br><span class="line">		msg.rooms = <span class="keyword">new</span> RoomInfo[count];</span><br><span class="line">		<span class="comment">//rooms</span></span><br><span class="line">		<span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">foreach</span>(Room room <span class="keyword">in</span> rooms.Values)&#123;</span><br><span class="line">			RoomInfo roomInfo = <span class="keyword">new</span> RoomInfo();</span><br><span class="line">			<span class="comment">//赋值</span></span><br><span class="line">			roomInfo.id = room.id;</span><br><span class="line">			roomInfo.count = room.playerIds.Count;</span><br><span class="line">			roomInfo.status = (<span class="built_in">int</span>)room.status;</span><br><span class="line"></span><br><span class="line">			msg.rooms[i] = roomInfo;</span><br><span class="line">			i++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> msg;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Update</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Update</span>()</span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span>(Room room <span class="keyword">in</span> rooms.Values)&#123;</span><br><span class="line">			room.Update();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="七-服务端消息处理"><a href="#七-服务端消息处理" class="headerlink" title="七.服务端消息处理"></a>七.服务端消息处理</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MsgHandler</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//查询战绩</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MsgGetAchieve</span>(<span class="params">ClientState c, MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		MsgGetAchieve msg = (MsgGetAchieve)msgBase;</span><br><span class="line">		Player player = c.player;</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		msg.win = player.data.win;</span><br><span class="line">		msg.lost = player.data.lost;</span><br><span class="line"></span><br><span class="line">		player.Send(msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//请求房间列表</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MsgGetRoomList</span>(<span class="params">ClientState c, MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		MsgGetRoomList msg = (MsgGetRoomList)msgBase;</span><br><span class="line">		Player player = c.player;</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		player.Send(RoomManager.ToMsg());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建房间</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MsgCreateRoom</span>(<span class="params">ClientState c, MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		MsgCreateRoom msg = (MsgCreateRoom)msgBase;</span><br><span class="line">		Player player = c.player;</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">//已经在房间里</span></span><br><span class="line">		<span class="keyword">if</span>(player.roomId &gt;=<span class="number">0</span> )&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//创建</span></span><br><span class="line">		Room room = RoomManager.AddRoom();</span><br><span class="line">		room.AddPlayer(player.id);</span><br><span class="line"></span><br><span class="line">		msg.result = <span class="number">0</span>;</span><br><span class="line">		player.Send(msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进入房间</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MsgEnterRoom</span>(<span class="params">ClientState c, MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		MsgEnterRoom msg = (MsgEnterRoom)msgBase;</span><br><span class="line">		Player player = c.player;</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">//已经在房间里</span></span><br><span class="line">		<span class="keyword">if</span>(player.roomId &gt;=<span class="number">0</span> )&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//获取房间</span></span><br><span class="line">		Room room = RoomManager.GetRoom(msg.id);</span><br><span class="line">		<span class="keyword">if</span>(room == <span class="literal">null</span>)&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//进入</span></span><br><span class="line">		<span class="keyword">if</span>(!room.AddPlayer(player.id))&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//返回协议	</span></span><br><span class="line">		msg.result = <span class="number">0</span>;</span><br><span class="line">		player.Send(msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取房间信息</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MsgGetRoomInfo</span>(<span class="params">ClientState c, MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		MsgGetRoomInfo msg = (MsgGetRoomInfo)msgBase;</span><br><span class="line">		Player player = c.player;</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		Room room = RoomManager.GetRoom(player.roomId);</span><br><span class="line">		<span class="keyword">if</span>(room == <span class="literal">null</span>)&#123;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		player.Send(room.ToMsg());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//离开房间</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MsgLeaveRoom</span>(<span class="params">ClientState c, MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		MsgLeaveRoom msg = (MsgLeaveRoom)msgBase;</span><br><span class="line">		Player player = c.player;</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		Room room = RoomManager.GetRoom(player.roomId);</span><br><span class="line">		<span class="keyword">if</span>(room == <span class="literal">null</span>)&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		room.RemovePlayer(player.id);</span><br><span class="line">		<span class="comment">//返回协议</span></span><br><span class="line">		msg.result = <span class="number">0</span>;</span><br><span class="line">		player.Send(msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//请求开始战斗</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MsgStartBattle</span>(<span class="params">ClientState c, MsgBase msgBase</span>)</span>&#123;</span><br><span class="line">		MsgStartBattle msg = (MsgStartBattle)msgBase;</span><br><span class="line">		Player player = c.player;</span><br><span class="line">		<span class="keyword">if</span>(player == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">//room</span></span><br><span class="line">		Room room = RoomManager.GetRoom(player.roomId);</span><br><span class="line">		<span class="keyword">if</span>(room == <span class="literal">null</span>)&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//是否是房主</span></span><br><span class="line">		<span class="keyword">if</span>(!room.isOwner(player))&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//开战</span></span><br><span class="line">		<span class="keyword">if</span>(!room.StartBattle())&#123;</span><br><span class="line">			msg.result = <span class="number">1</span>;</span><br><span class="line">			player.Send(msg);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//成功</span></span><br><span class="line">		msg.result = <span class="number">0</span>;</span><br><span class="line">		player.Send(msg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-玩家断线事件处理"><a href="#1-玩家断线事件处理" class="headerlink" title="1.玩家断线事件处理"></a>1.玩家断线事件处理</h2><p>网络游戏当中,总避免不了断线情况,程序应该做出处理.比如玩家进入房间之后掉线了,可以视作玩家在网络断开前自行退出了房间.此时EventHandler类中的OnDisconnect函数会在掉线前被调用,可以在这里做出退出房间的逻辑处理.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnDisconnect</span>(<span class="params">ClientState c</span>)</span>&#123;</span><br><span class="line">		Console.WriteLine(<span class="string">&quot;Close&quot;</span>);</span><br><span class="line">		<span class="comment">//Player下线</span></span><br><span class="line">		<span class="keyword">if</span>(c.player != <span class="literal">null</span>)&#123;</span><br><span class="line">			<span class="comment">//离开战场</span></span><br><span class="line">			<span class="built_in">int</span> roomId = c.player.roomId;</span><br><span class="line">			<span class="keyword">if</span>(roomId &gt;= <span class="number">0</span>)&#123;  <span class="comment">//如果玩家掉线了但还显示在房间中,则移除</span></span><br><span class="line">				Room room = RoomManager.GetRoom(roomId);</span><br><span class="line">				room.RemovePlayer(c.player.id);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//保存数据</span></span><br><span class="line">			DbManager.UpdatePlayerData(c.player.id, c.player.data);</span><br><span class="line">			<span class="comment">//移除</span></span><br><span class="line">			PlayerManager.RemovePlayer(c.player.id);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h1 id="八-一些额外实现的功能"><a href="#八-一些额外实现的功能" class="headerlink" title="八.一些额外实现的功能"></a>八.一些额外实现的功能</h1><h2 id="1-登录系统"><a href="#1-登录系统" class="headerlink" title="1.登录系统"></a>1.登录系统</h2><ul>
<li>Update1:</li>
</ul>
<h2 id="2-房间系统"><a href="#2-房间系统" class="headerlink" title="2.房间系统"></a>2.房间系统</h2><h3 id="update1"><a href="#update1" class="headerlink" title="update1"></a>update1</h3><ul>
<li>Update1:创建房间的时候显示房间号(这也是为了方便后续有人加入)</li>
</ul>
<p>(1)修改协议内容(客户端+服务端)</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取房间信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MsgGetRoomInfo</span> : <span class="title">MsgBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MsgGetRoomInfo</span>()</span> &#123; protoName = <span class="string">&quot;MsgGetRoomInfo&quot;</span>; &#125;</span><br><span class="line">    <span class="comment">//服务端回</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> roomId; <span class="comment">//2022.5.8新增:房间的编号信息,为了显示在Text上</span></span><br><span class="line">    <span class="keyword">public</span> PlayerInfo[] players;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(2)</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成MsgGetRoomInfo协议</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MsgBase <span class="title">ToMsg</span>()</span>&#123;</span><br><span class="line">		MsgGetRoomInfo msg = <span class="keyword">new</span> MsgGetRoomInfo();</span><br><span class="line">		<span class="built_in">int</span> count = playerIds.Count;</span><br><span class="line">		msg.players = <span class="keyword">new</span> PlayerInfo[count]; <span class="comment">//服务端要回复给客户端的内容</span></span><br><span class="line">        msg.roomId = id; <span class="comment">//2022.5.8新增:房间的编号信息,为了显示在Text上</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>(3)修改客户端的显示,使房间号可以显示在Text上(对RoomPanel类修改如下)</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//显示房间</span></span><br><span class="line"><span class="keyword">private</span> Text roomId;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    roomId = skin.transform.Find(<span class="string">&quot;roomName&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//收到玩家列表协议</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgGetRoomInfo</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    MsgGetRoomInfo msg = (MsgGetRoomInfo)msgBase;</span><br><span class="line">    roomId.text = <span class="string">&quot;房间号: &quot;</span>+msg.roomId.ToString();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Update2"><a href="#Update2" class="headerlink" title="Update2"></a>Update2</h3><ul>
<li>Update2:增加加入房间功能(需要输入一个房间号)</li>
</ul>
<p>(1)首先,设计一个界面:</p>
<p><img src="https://cdn.jsdelivr.net/gh/hhlovesyy/ImgHosting/Unity/GameUI/image-20220508205249047.png" alt="image-20220508205249047"></p>
<p>后续还会加入与房间验证码有关的内容,目前就暂时用房间号进行测试;将这个做完的面板放入到Resources文件夹当中,同时创建JoinRoomPanel.cs类</p>
<p>(2)设计一个JoinRoomPanel类,用来处理上面那个界面,同样要继承于BasePanel类:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JoinRoomPanel</span> : <span class="title">BasePanel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//加入房间按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button joinButton;</span><br><span class="line">    <span class="comment">//退出按钮</span></span><br><span class="line">    <span class="keyword">private</span> Button closeButton;</span><br><span class="line">    <span class="comment">//房间号,由玩家手动输入,进入该房间</span></span><br><span class="line">    <span class="keyword">private</span> InputField roomNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        skinPath = <span class="string">&quot;JoinRoomPanel&quot;</span>;</span><br><span class="line">        layer = PanelManager.Layer.Panel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//显示</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnShow</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//寻找组件</span></span><br><span class="line">        joinButton = skin.transform.Find(<span class="string">&quot;CreateOrJumpIntoRoom/FightReady&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        closeButton = skin.transform.Find(<span class="string">&quot;CreateOrJumpIntoRoom/Exit&quot;</span>).GetComponent&lt;Button&gt;();</span><br><span class="line">        roomNum = skin.transform.Find(<span class="string">&quot;CreateOrJumpIntoRoom/InputRoomNumber&quot;</span>).GetComponent&lt;InputField&gt;();</span><br><span class="line"></span><br><span class="line">        joinButton.onClick.AddListener(OnJoinClick);</span><br><span class="line">        closeButton.onClick.AddListener(OnCloseClick);</span><br><span class="line">        <span class="comment">//协议监听</span></span><br><span class="line">        NetManager.AddMsgListener(<span class="string">&quot;MsgEnterRoom&quot;</span>, OnMsgEnterRoom);</span><br><span class="line">        <span class="comment">//发送查询</span></span><br><span class="line">        MsgGetRoomInfo msg = <span class="keyword">new</span> MsgGetRoomInfo();</span><br><span class="line">        NetManager.Send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMsgEnterRoom</span>(<span class="params">MsgBase msgBase</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgEnterRoom msg = (MsgEnterRoom)msgBase;</span><br><span class="line">        <span class="comment">//成功进入房间</span></span><br><span class="line">        <span class="keyword">if</span> (msg.result == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;RoomPanel&gt;();</span><br><span class="line">            Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进入房间失败</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;进入房间失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//协议监听</span></span><br><span class="line">        NetManager.RemoveMsgListener(<span class="string">&quot;MsgEnterRoom&quot;</span>, OnMsgEnterRoom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点击加入房间按钮之后</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnJoinClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> roomN = roomNum.text;</span><br><span class="line">        <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">int</span>.TryParse(roomN, <span class="keyword">out</span> result))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//此时转换后的结果为result,相当于申请加入result号房间</span></span><br><span class="line">            MsgEnterRoom msg = <span class="keyword">new</span> MsgEnterRoom();</span><br><span class="line">            msg.id = result;</span><br><span class="line">            NetManager.Send(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            PanelManager.Open&lt;TipPanel&gt;(<span class="string">&quot;输入的房间号不合法或未开启!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//点击退出按钮</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCloseClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Close();</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>(3)在RoomListPanel当中新增监听函数:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点击左侧加入房间按钮,输入房间号加入房间</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnEnterClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PanelManager.Open&lt;JoinRoomPanel&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="Update3"><a href="#Update3" class="headerlink" title="Update3"></a>Update3</h3><ul>
<li>Update3:增加服务端的动物选择逻辑,来替代原来程序的阵营,这里规定如下:<ul>
<li>1.鸡</li>
<li>2.牛</li>
<li>3.蛇</li>
<li>4.虎</li>
<li>5.狗</li>
</ul>
</li>
</ul>
<p>因此,服务端要做出如下修改:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对Room.cs做出如下修改:</span></span><br><span class="line"><span class="comment">//2022.5.8 新增:每个玩家的camp</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span>[] camps = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">13</span>];</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">SwitchCamp</span>()</span> &#123;</span><br><span class="line">        <span class="comment">//修改服务端的逻辑,分配小动物</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> id <span class="keyword">in</span> playerIds.Keys)</span><br><span class="line">        &#123;</span><br><span class="line">            Player player = PlayerManager.GetPlayer(id);</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">1</span>;i&lt;=maxPlayer;i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(camps[i]==<span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    camps[i] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">return</span> i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除玩家</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemovePlayer</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//删除列表</span></span><br><span class="line">		playerIds.Remove(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2022.5.8 删除这个玩家的小动物信息</span></span><br><span class="line">        camps[player.camp] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>客户端只需要对player.camp进行调整即可:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个玩家信息单元</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GeneratePlayerInfo</span>(<span class="params">PlayerInfo playerInfo</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建物体</span></span><br><span class="line">        GameObject o = Instantiate(playerObj);</span><br><span class="line">        o.transform.SetParent(content,<span class="literal">false</span>); <span class="comment">//这里务必设置成false否则会有bug</span></span><br><span class="line">        o.SetActive(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//获取组件</span></span><br><span class="line">        Transform trans = o.transform;</span><br><span class="line">        Text idText = trans.Find(<span class="string">&quot;Name&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        Text campText = trans.Find(<span class="string">&quot;Camp&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        Text scoreText = trans.Find(<span class="string">&quot;Status&quot;</span>).GetComponent&lt;Text&gt;();</span><br><span class="line">        <span class="comment">//填充信息</span></span><br><span class="line">        idText.text = playerInfo.id;</span><br><span class="line">        <span class="keyword">switch</span>(playerInfo.camp)  <span class="comment">//后续有补充需要再在这里补充一下</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                campText.text = <span class="string">&quot;鸡&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                campText.text = <span class="string">&quot;牛&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                campText.text = <span class="string">&quot;蛇&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                campText.text = <span class="string">&quot;虎&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                campText.text = <span class="string">&quot;狗&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (playerInfo.isOwner == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            campText.text = campText.text;</span><br><span class="line">        &#125;</span><br><span class="line">        scoreText.text = playerInfo.win + <span class="string">&quot;胜 &quot;</span> + playerInfo.lost + <span class="string">&quot;负&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="Update4"><a href="#Update4" class="headerlink" title="Update4"></a>Update4</h3><ul>
<li>Update4:房主显示开始!其他玩家显示准备!同时界面上有标签显示(该玩家的状态是准备还是未准备)</li>
</ul>
<h3 id="Update-5"><a href="#Update-5" class="headerlink" title="Update 5"></a>Update 5</h3><ul>
<li>Update5:开战之后为每个玩家分配形象和场地中的生成位置</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>ChrisZhang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2022/05/10/Unity%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" title="Unity网络游戏房间系统设计">http://example.com/2022/05/10/Unity网络游戏房间系统设计/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1/" rel="tag"># 网络游戏设计</a>
              <a href="/tags/Unity/" rel="tag"># Unity</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/07/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8/" rel="prev" title="汇编语言入门">
      <i class="fa fa-chevron-left"></i> 汇编语言入门
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/10/Linux%E9%83%A8%E7%BD%B2C-%E5%92%8CMySQL%E7%8E%AF%E5%A2%83/" rel="next" title="Linux部署C#和MySQL环境">
      Linux部署C#和MySQL环境 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E4%B8%8E%E6%B8%B8%E6%88%8F%E6%88%BF%E9%97%B4%E5%A4%A7%E5%8E%85%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.</span> <span class="nav-text">注册登录与游戏房间大厅系统的设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%9D%91%E6%B3%A8%E6%84%8F"><span class="nav-number">1.1.</span> <span class="nav-text">一些坑注意:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80-%E5%BC%BA%E5%A4%A7%E7%9A%84%E9%80%9A%E7%94%A8%E7%95%8C%E9%9D%A2%E6%A8%A1%E5%9D%97"><span class="nav-number">2.</span> <span class="nav-text">一.强大的通用界面模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E9%80%9A%E7%94%A8%E7%95%8C%E9%9D%A2%E6%A8%A1%E5%9D%97"><span class="nav-number">2.1.</span> <span class="nav-text">1.通用界面模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E8%AF%B4%E6%98%8E"><span class="nav-number">2.1.1.</span> <span class="nav-text">其他说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%9C%BA%E6%99%AF%E7%BB%93%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">2.场景结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%9D%A2%E6%9D%BF%E5%9F%BA%E7%B1%BBBasePanel"><span class="nav-number">2.3.</span> <span class="nav-text">3.面板基类BasePanel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%AE%BE%E8%AE%A1%E8%A6%81%E7%82%B9"><span class="nav-number">2.3.1.</span> <span class="nav-text">(1)设计要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.3.2.</span> <span class="nav-text">(2) 代码实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%95%8C%E9%9D%A2%E7%AE%A1%E7%90%86%E5%99%A8PanelManager"><span class="nav-number">2.4.</span> <span class="nav-text">4.界面管理器PanelManager</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C-%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.</span> <span class="nav-text">二.登录注册系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%99%BB%E5%BD%95%E9%9D%A2%E6%9D%BF"><span class="nav-number">3.1.</span> <span class="nav-text">1.登录面板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%A1%A5%E5%85%85-%E5%85%B3%E4%BA%8E%E5%AF%86%E7%A0%81%E6%A1%86%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="nav-number">3.1.1.</span> <span class="nav-text">(1)补充:关于密码框的设置:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-LoginPanel%E7%B1%BB%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.1.2.</span> <span class="nav-text">(2)LoginPanel类的设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EGameMain%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">关于GameMain的说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-TipPanel%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.3.</span> <span class="nav-text">(3)TipPanel的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%B3%A8%E5%86%8C%E9%9D%A2%E6%9D%BF"><span class="nav-number">3.2.</span> <span class="nav-text">2.注册面板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-RegisterPanel%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.2.1.</span> <span class="nav-text">(1)RegisterPanel的设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E6%B3%A8%E5%86%8C%E9%9D%A2%E6%9D%BF%E7%B1%BB%E7%9A%84%E4%B9%A6%E5%86%99"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">(a)注册面板类的书写</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89-%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F"><span class="nav-number">4.</span> <span class="nav-text">三.房间系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">1.整体结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1"><span class="nav-number">4.2.</span> <span class="nav-text">2.协议设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%97%E8%A1%A8%E9%9D%A2%E6%9D%BF%E9%80%BB%E8%BE%91"><span class="nav-number">4.3.</span> <span class="nav-text">3.列表面板逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%9D%A2%E6%9D%BF%E7%B1%BBRoomListPanel"><span class="nav-number">4.3.1.</span> <span class="nav-text">(1)面板类RoomListPanel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%88%BF%E9%97%B4%E7%B1%BBRoomPanel"><span class="nav-number">4.3.2.</span> <span class="nav-text">(2)房间类RoomPanel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%85%B3%E4%BA%8E%E4%BF%9D%E5%AD%98%E9%A2%84%E5%88%B6%E4%BD%93%E7%9A%84%E7%BB%86%E8%8A%82-%E5%AE%B9%E6%98%93%E5%87%BA%E9%94%99"><span class="nav-number">4.4.</span> <span class="nav-text">4.关于保存预制体的细节(容易出错!)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%8E%A9%E5%AE%B6%E6%95%B0%E6%8D%AE"><span class="nav-number">5.</span> <span class="nav-text">四.服务端玩家数据</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%88%BF%E9%97%B4%E7%B1%BB"><span class="nav-number">6.</span> <span class="nav-text">五.服务端房间类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%88%BF%E9%97%B4%E7%B1%BB%E7%9A%84%E8%AE%BE%E8%AE%A1%E8%A6%81%E7%82%B9"><span class="nav-number">6.1.</span> <span class="nav-text">1.房间类的设计要点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B7%BB%E5%8A%A0%E7%8E%A9%E5%AE%B6"><span class="nav-number">6.1.1.</span> <span class="nav-text">(1)添加玩家</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%A0%E9%99%A4%E7%8E%A9%E5%AE%B6"><span class="nav-number">6.1.2.</span> <span class="nav-text">(2)删除玩家</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%94%9F%E6%88%90%E6%88%BF%E9%97%B4%E4%BF%A1%E6%81%AF"><span class="nav-number">6.1.3.</span> <span class="nav-text">(3)生成房间信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%88%BF%E9%97%B4%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">7.</span> <span class="nav-text">六.服务端房间管理器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="nav-number">8.</span> <span class="nav-text">七.服务端消息处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8E%A9%E5%AE%B6%E6%96%AD%E7%BA%BF%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">8.1.</span> <span class="nav-text">1.玩家断线事件处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB-%E4%B8%80%E4%BA%9B%E9%A2%9D%E5%A4%96%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-number">9.</span> <span class="nav-text">八.一些额外实现的功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%99%BB%E5%BD%95%E7%B3%BB%E7%BB%9F"><span class="nav-number">9.1.</span> <span class="nav-text">1.登录系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%88%BF%E9%97%B4%E7%B3%BB%E7%BB%9F"><span class="nav-number">9.2.</span> <span class="nav-text">2.房间系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#update1"><span class="nav-number">9.2.1.</span> <span class="nav-text">update1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update2"><span class="nav-number">9.2.2.</span> <span class="nav-text">Update2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update3"><span class="nav-number">9.2.3.</span> <span class="nav-text">Update3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update4"><span class="nav-number">9.2.4.</span> <span class="nav-text">Update4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update-5"><span class="nav-number">9.2.5.</span> <span class="nav-text">Update 5</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ChrisZhang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">ChrisZhang</p>
  <div class="site-description" itemprop="description">我的技美学习之路</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hhlovesyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hhlovesyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1596944152@qq.com" title="E-Mail → mailto:1596944152@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/liang-dao-men" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;liang-dao-men" rel="noopener" target="_blank"><i class="fa fa-quora fa-fw"></i>知乎</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      链接网站
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.zhihu.com/people/liang-dao-men" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;liang-dao-men" rel="noopener" target="_blank">个人知乎</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://space.bilibili.com/24361666" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;24361666" rel="noopener" target="_blank">个人bilibili</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Sat Apr 30 2022 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ChrisZhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
